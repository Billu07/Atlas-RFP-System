<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vendor Dashboard | Atlas RFP Portal</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <a href="dashboard.html" class="logo">
            <img
              src="../assets/images/logo.png"
              alt="Atlas Consulting"
              onerror="this.style.display='none'"
            />
            <span>Atlas RFP Portal</span>
          </a>
          <nav>
            <ul class="nav-links">
              <li>
                <span style="color: var(--text-light)"
                  >Welcome, <strong id="vendor-name-header"></strong
                ></span>
              </li>
              <li>
                <a href="dashboard.html" class="active">Dashboard</a>
              </li>
              <li><a href="my-submissions.html">My Submissions</a></li>
              <li>
                <button class="btn btn-sm btn-ghost" onclick="logout()">
                  Logout
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <h1>Vendor Dashboard</h1>
        <p>Browse active RFPs and submit your proposals</p>
      </div>
    </section>

    <!-- Main Content -->
    <main class="container" style="padding: 3rem 1.5rem">
      <!-- Stats Section -->
      <div class="grid grid-3 mb-4">
        <div class="card">
          <div class="card-body text-center">
            <h2
              id="stat-active-rfps"
              style="
                color: var(--primary-color);
                font-size: 2rem;
                margin-bottom: 0.5rem;
              "
            >
              0
            </h2>
            <p style="color: var(--text-light); margin: 0">Active RFPs</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body text-center">
            <h2
              id="stat-my-submissions"
              style="
                color: var(--accent-color);
                font-size: 2rem;
                margin-bottom: 0.5rem;
              "
            >
              0
            </h2>
            <p style="color: var(--text-light); margin: 0">My Submissions</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body text-center">
            <h2
              id="stat-pending-review"
              style="
                color: var(--warning-color);
                font-size: 2rem;
                margin-bottom: 0.5rem;
              "
            >
              0
            </h2>
            <p style="color: var(--text-light); margin: 0">Under Review</p>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading" class="text-center" style="padding: 3rem 0">
        <div
          class="spinner"
          style="
            width: 40px;
            height: 40px;
            border-width: 4px;
            border-color: var(--primary-color);
            border-top-color: var(--border-color);
            margin: 0 auto;
          "
        ></div>
        <p style="margin-top: 1rem; color: var(--text-light)">
          Loading RFPs...
        </p>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden">
        <div class="card" style="border-left: 4px solid var(--error-color)">
          <h3>Unable to Load RFPs</h3>
          <p id="error-message">
            There was an error loading the RFPs. Please try again.
          </p>
          <button class="btn btn-primary mt-2" onclick="loadDashboard()">
            Retry
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty" class="hidden text-center" style="padding: 3rem 0">
        <svg
          width="64"
          height="64"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          style="margin: 0 auto; color: var(--text-light)"
        >
          <path
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 style="margin-top: 1rem">No Active RFPs</h3>
        <p style="color: var(--text-light)">
          There are currently no active requests for proposals. Please check
          back later.
        </p>
      </div>

      <!-- RFP List -->
      <div id="rfp-list" class="hidden">
        <h2 style="margin-bottom: 2rem">Active RFPs Available to You</h2>
        <div id="rfp-grid" class="grid grid-2">
          <!-- RFP cards will be inserted here -->
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer
      style="
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
        padding: 2rem 0;
        margin-top: 4rem;
      "
    >
      <div class="container text-center">
        <p style="color: var(--text-light); margin: 0">
          Â© 2025 Atlas Consulting. All rights reserved. |
          <a href="mailto:rfp@atlasconsulting.com">Contact Support</a>
        </p>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="../config.js"></script>
    <script src="../assets/js/airtable-api.js"></script>
    <script>
      let airtableAPI;
      let vendorId;
      let vendorEmail;

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", async () => {
        checkAuth();
        await initializeDashboard();
      });

      // Check if vendor is authenticated
      function checkAuth() {
        const isAuthenticated = sessionStorage.getItem("vendor_authenticated");
        const loginTime = sessionStorage.getItem("vendor_login_time");

        if (!isAuthenticated || !loginTime) {
          window.location.href = "login.html";
          return;
        }

        // Check if session is older than 8 hours
        const hoursSinceLogin =
          (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60);
        if (hoursSinceLogin > 8) {
          logout();
        }

        // Get vendor info
        vendorId = sessionStorage.getItem("vendor_id");
        vendorEmail = sessionStorage.getItem("vendor_email");
        const vendorName = sessionStorage.getItem("vendor_name");

        // Display vendor name
        document.getElementById("vendor-name-header").textContent = vendorName;
      }

      // Initialize dashboard
      async function initializeDashboard() {
        try {
          if (typeof CONFIG === "undefined") {
            throw new Error("Configuration not found");
          }

          airtableAPI = new AirtableAPI(CONFIG);
          await loadDashboard();
        } catch (error) {
          console.error("Initialization error:", error);
          showError(error.message);
        }
      }

      // Load dashboard data
      async function loadDashboard() {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const empty = document.getElementById("empty");
        const rfpList = document.getElementById("rfp-list");

        // Reset states
        loading.classList.remove("hidden");
        error.classList.add("hidden");
        empty.classList.add("hidden");
        rfpList.classList.add("hidden");

        try {
          // Load active RFPs
          const rfps = await airtableAPI.getActiveRFPs();

          // Load vendor's submissions
          const allSubmissions = await airtableAPI.getAllSubmissions();
          const mySubmissions = allSubmissions.filter(
            (s) => s.fields["Email"] === vendorEmail
          );
          const pendingSubmissions = mySubmissions.filter(
            (s) =>
              s.fields["Review Status"] === "Pending" ||
              s.fields["Review Status"] === "Under Review"
          );

          // Update stats
          document.getElementById("stat-active-rfps").textContent = rfps.length;
          document.getElementById("stat-my-submissions").textContent =
            mySubmissions.length;
          document.getElementById("stat-pending-review").textContent =
            pendingSubmissions.length;

          loading.classList.add("hidden");

          if (rfps.length === 0) {
            empty.classList.remove("hidden");
          } else {
            rfpList.classList.remove("hidden");
            renderRFPs(rfps, mySubmissions);
          }
        } catch (err) {
          console.error("Error loading dashboard:", err);
          loading.classList.add("hidden");
          showError(err.message);
        }
      }

      // Render RFP cards
      function renderRFPs(rfps, mySubmissions) {
        const grid = document.getElementById("rfp-grid");
        grid.innerHTML = "";

        rfps.forEach((rfp) => {
          const fields = rfp.fields;
          const deadline = new Date(fields["Submission Deadline"]);
          const daysLeft = Math.ceil(
            (deadline - new Date()) / (1000 * 60 * 60 * 24)
          );

          // Check if vendor has already submitted to this RFP
          const hasSubmitted = mySubmissions.some((s) => {
            const rfpLinks = s.fields["RFP"];
            return rfpLinks && rfpLinks.includes(rfp.id);
          });

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="card-title">${escapeHtml(fields["RFP Name"])}</div>
              <div class="card-subtitle">RFP #${fields["RFP ID"]}</div>
            </div>
            <div style="text-align: right;">
              <span class="badge ${
                daysLeft <= 3 ? "badge-warning" : "badge-success"
              }">
                ${daysLeft} day${daysLeft !== 1 ? "s" : ""} left
              </span>
              ${
                hasSubmitted
                  ? '<div style="margin-top: 0.5rem;"><span class="badge badge-info">Submitted</span></div>'
                  : ""
              }
            </div>
          </div>
          <div class="card-body">
            <p>${escapeHtml(
              fields["Objective"] || "No description available"
            )}</p>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
              ${
                fields["Budget Guidance"]
                  ? `
                <div>
                  <small style="color: var(--text-light); display: block;">Budget</small>
                  <strong>${escapeHtml(fields["Budget Guidance"])}</strong>
                </div>
              `
                  : ""
              }
              <div>
                <small style="color: var(--text-light); display: block;">Deadline</small>
                <strong>${formatDate(deadline)}</strong>
              </div>
            </div>
          </div>
          <div class="card-footer">
            ${
              hasSubmitted
                ? `<button class="btn btn-secondary" disabled>Already Submitted</button>`
                : `<a href="rfp-detail.html?id=${rfp.id}" class="btn btn-primary">
                View Details & Submit
              </a>`
            }
          </div>
        `;
          grid.appendChild(card);
        });
      }

      // Show error message
      function showError(message) {
        const error = document.getElementById("error");
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = message;
        error.classList.remove("hidden");
      }

      // Logout
      function logout() {
        sessionStorage.removeItem("vendor_authenticated");
        sessionStorage.removeItem("vendor_id");
        sessionStorage.removeItem("vendor_name");
        sessionStorage.removeItem("vendor_email");
        sessionStorage.removeItem("vendor_login_time");
        window.location.href = "login.html";
      }

      // Utility functions
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(date) {
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }
    </script>
  </body>
</html>
